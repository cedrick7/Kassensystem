{% extends 'base.html' %}
{% load static %}
{% load bootstrap4 %}
{% load widget_tweaks %}

<!-- Head -->
{% block specific %}
<title>Analyst - Mitarbeiter</title>

<link rel="stylesheet" type="text/css" href="{% static 'css/analyzation_navbar.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/analyzation_styles.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/lightpicker.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/chartjs.css' %}" />
{% endblock specific %}

<!-- Body -->
{% block navbar %}
    {% include 'analyzation_navbar.html' %}
{% endblock navbar %}

{% block content %}
<section id="body">
    <div class="heading container-fluid">
        <!-- change this content -->
        <h3>Mitarbeiteranalyse</h3>
    </div>
    <div class="content container-fluid">

        <!-- Kassen (Online-Status, Mitarbeitername, Kasseninhalt) [card] -->
        <div class="row-card row">
          <div class="col-card col-12 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <div class="cashbox-heading"><span>Kasse #1</span></div>
                    <div class="text-3"><span>Mitarbeitername 1</span></div>
                    <div class="text-4"><span>40.000€</span></div>
                  </div>
                  <div class="col-auto"><i class="fas fa-circle fa-2x status-online"></i></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-card col-12 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <div class="cashbox-heading"><span>Kasse #2</span></div>
                    <div class="text-3"><span>Mitarbeitername 2</span></div>
                    <div class="text-4"><span>40.000€</span></div>
                  </div>
                  <div class="col-auto"><i class="fas fa-circle fa-2x status-online"></i></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-card col-12 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <div class="cashbox-heading"><span>Kasse #3</span></div>
                    <div class="text-3"><span>-</span></div>
                    <div class="text-4"><span>-</span></div>
                  </div>
                  <div class="col-auto">
                      <i class="fas fa-circle fa-2x status-offline"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mitarbeiterzeiten [line-chart] -->
        <div class="row-chart row">
          <div class="col-chart col-12">
            <div class="card">
              <div class="card-header">
              <!-- change this content -->
              <p>Mitarbeiterzeiten Überblick</p>
            </div>
              <div class="card-body" style="overflow-x: scroll;">
                  <div class="row">
                      <div class="col-12 col-filter">
                          <form id="" method="post" class="daterange-form needs-validation">{% csrf_token %}
                              <!-- Daterange -->
                              <div class="form-group date-select col">
                                <div class="input-group input-daterange">
                                  <div class="input-group-prepend">
                                    <span class="input-group-text">Zeitraum</span>
                                  </div>
                                    <!--
                                  <input class="form-control" type="text" id="dateRangePicker" placeholder="18.08.2020 - 23.08.2020">
                                    -->
                                  {{ form.dateRange1 }}
                                  <div class="invalid-feedback">
                                    {{ form.dateRange1.errors }}
                                  </div>
                                </div>
                              </div>

                              <!-- Submit -->
                              <div class="form-group col-6">
                                  <button id="submit-dateRange" class="btn btn-primary btn-block" type="submit">Filtern!</button>
                              </div>
                          </form>
                      </div>
                      <div class="col col-chart">
                          <div class="chart-area">
                              <div class="chart-div line-chart" style="position: relative; height:100%; width:100%; min-height:400px; min-width: 350px;">
                                  <canvas id="employeesTimesChartData" class="chart"></canvas>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mitarbeiterumsatz [line-chart] -->
        <div class="row-chart row">
          <div class="col-chart col-12">
            <div class="card">
              <div class="card-header">
              <!-- change this content -->
              <p>Mitarbeiterumsatz Überblick</p>
            </div>
              <div class="card-body" style="overflow-x: scroll;">
                  <div class="row">
                      <div class="col-12 col-filter">
                          <form id="" method="post" class="daterange-form needs-validation">{% csrf_token %}
                              <!-- Daterange -->
                              <div class="form-group date-select col">
                                <div class="input-group input-daterange">
                                  <div class="input-group-prepend">
                                    <span class="input-group-text">Zeitraum</span>
                                  </div>
                                    <!--
                                  <input class="form-control" type="text" id="dateRangePicker" placeholder="18.08.2020 - 23.08.2020">
                                    -->
                                  {{ form.dateRange2 }}
                                  <div class="invalid-feedback">
                                    {{ form.dateRange2.errors }}
                                  </div>
                                </div>
                              </div>

                              <!-- Submit -->
                              <div class="form-group col-6">
                                  <button id="submit-dateRange" class="btn btn-primary btn-block" type="submit">Filtern!</button>
                              </div>
                          </form>
                      </div>
                      <div class="col col-chart">
                          <div class="chart-area">
                              <div class="chart-div line-chart" style="position: relative; height:100%; width:100%; min-height:400px; min-width: 350px;">
                                  <canvas id="employeesRevenueChartData" class="chart"></canvas>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
            </div>
          </div>
        </div>

    </div>
</section>
{% endblock content %}

{% block javascript %}
<!-- DateRange -->
<script type="text/javascript" src="{% static 'js/moment.js' %}"></script>
<script type="text/javascript" src="{% static 'js/lightpicker.js' %}"></script>
<script type="text/javascript" src="{% static 'js/datepicker.js' %}"></script>

<!-- ChartJS -->
<script type="text/javascript" src="{% static 'js/chartjs.js' %}"></script>

<script type="text/javascript" src="{% static 'js/analyzation_navbar.js' %}"></script>
{% endblock javascript %}

<!-- Chart.js -->
{% block chart.js %}
<script>

    // DATA
    const endpoint = '{% url "api-employees-chart-data" %}'
    var employee_times_data = []
    var employee_times_labels = []
    var employee_times_chart_labels = []
    var employee_times_chart_legend = ''
    var employee_times_x_axes = ''
    var employee_times_y_axes = ''
    var employee_revenue_data = []
    var employee_revenue_labels = []
    var employee_revenue_chart_labels = []
    var employee_revenue_chart_legend = ''
    var employee_revenue_x_axes = ''
    var employee_revenue_y_axes = ''

    // COLORS
    var color_background = ['rgba(255,99,132,0.2)', 'rgba(61,236,245,0.2)', 'rgba(50,133,250,0.2)', 'rgba(243,211,131,0.2)', 'rgba(143,255,152,0.2)', 'rgba(50,133,250,0.2)', 'rgba(165,97,255,0.2)', 'rgba(243,211,131,0.2)', 'rgba(143,255,152,0.2)', 'rgba(254,177,249,0.2)', 'rgba(255,133,102,0.2)', 'rgba(243,211,131,0.2)', 'rgba(50,133,250,0.2)']
    var color_border = ['rgba(255,99,132,1)', 'rgba(61,236,245,1)', 'rgba(50,133,250,1)', 'rgba(243,211,131,1)', 'rgba(143,255,152,1)', 'rgba(50,133,250,1)', 'rgba(165,97,255,1)', 'rgba(243,211,131,1)', 'rgba(143,255,152,1)', 'rgba(254,177,249,1)', 'rgba(255,133,102,1)', 'rgba(243,211,131,1)', 'rgba(50,133,250,1)']


    $.ajax({
        method: "GET",
        url: endpoint,
        success: function (data) {
            employee_times_data = data.employee_times_data
            employee_times_labels = data.employee_times_labels
            employee_times_chart_labels = data.employee_times_chart_labels
            employee_times_chart_legend = data.employee_times_chart_legend
            employee_times_x_axes = data.employee_times_x_axes
            employee_times_y_axes = data.employee_times_y_axes
            employee_revenue_data = data.employee_revenue_data
            employee_revenue_labels = data.employee_revenue_labels
            employee_revenue_chart_labels = data.employee_revenue_chart_labels
            employee_revenue_chart_legend = data.employee_revenue_chart_legend
            employee_revenue_x_axes = data.employee_revenue_x_axes
            employee_revenue_y_axes = data.employee_revenue_y_axes

            setChart()
        },
        error: function (error_data) {
            console.log("error")
            console.log(error_data)
        }
    })

    function setChart() {

        // Mitarbeiterzeiten
        // config
        var config_employee_times_chart = {
            type: 'line',
            data: {
                labels: ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                title: {
                    display: true,
                    text: employee_times_chart_legend,
                    fontSize: 14,
                },
                legend: {
                    display: true,
                    labels: {
                        padding: 20,
                        boxWidth: 45,
                        fontSize: 14,
                    },
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: employee_times_x_axes
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: employee_times_y_axes
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
            };
        // define chart
        var employeesTimesChartData = document.getElementById('employeesTimesChartData').getContext('2d');
        window.employeesTimesChartData = new Chart(employeesTimesChartData, config_employee_times_chart);
        // fill chart
        employee_times_data.forEach(function (a, i) {

			if(color_background.length >= employee_revenue_data.length && color_border.length >= employee_revenue_data.length) {
                var newDataset = {
                    label: employee_times_labels[i],
                    backgroundColor: color_background[i],
                    borderColor: color_border[i],
                    data: employee_times_data[i],
                    fill: true,
                };
            } else {
                // if no more color is available
                bgC = random_color();
                bC = bgC;
                bgC += '0.2)';
                bC += '1)';

                var newDataset = {
                    label: employee_times_labels[i],
                    backgroundColor: bgC,
                    borderColor: bC,
                    data: employee_times_data[i],
                    fill: true,
                };
            }

			newDataset.data.push(employee_times_data[i]);

			config_employee_times_chart.data.datasets.push(newDataset);
			window.employeesTimesChartData.update();
        });

        // Mitarbeiterumsatz
        // config
        var config_employee_revenue_chart = {
            type: 'line',
            data: {
                labels: ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                title: {
                    display: true,
                    text: employee_revenue_chart_legend,
                    fontSize: 14,
                },
                legend: {
                    display: true,
                    labels: {
                        padding: 20,
                        boxWidth: 45,
                        fontSize: 14,
                    },
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: employee_revenue_x_axes
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: employee_revenue_y_axes
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        };
        // define chart
        var employeesRevenueChartData = document.getElementById('employeesRevenueChartData').getContext('2d');
        window.employeesRevenueChartData = new Chart(employeesRevenueChartData, config_employee_revenue_chart);
        // fill chart
        employee_revenue_data.forEach(function (a, i) {

            if(color_background.length >= employee_revenue_data.length && color_border.length >= employee_revenue_data.length) {
                var newDataset = {
                    label: employee_revenue_labels[i],
                    backgroundColor: color_background[i],
                    borderColor: color_border[i],
                    data: employee_revenue_data[i],
                    fill: true,
                };
            } else {
                // if no more color is available
                bgC = random_color();
                bC = bgC;
                bgC += '0.2)';
                bC += '1)';

                var newDataset = {
                    label: employee_revenue_labels[i],
                    backgroundColor: bgC,
                    borderColor: bC,
                    data: employee_revenue_data[i],
                    fill: true,
                };
            }

			newDataset.data.push(employee_revenue_data[i]);

			config_employee_revenue_chart.data.datasets.push(newDataset);
			window.employeesRevenueChartData.update();
        });

    }

    function random_color() {
        var x = Math.floor(Math.random() * 256);
        var y = Math.floor(Math.random() * 256);
        var z = Math.floor(Math.random() * 256);
        var bgColor = "rgb(" + x + "," + y + "," + z + ",";
        return bgColor;
    }
</script>
{% endblock chart.js %}